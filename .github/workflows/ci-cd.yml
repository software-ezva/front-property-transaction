name: Frontend CI/CD Pipeline

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

env:
  # --- 1. PROJECT CONFIGURATION ---
  PROJECT_ID: property-transaction
  REGION: us-east1

  # --- 2. ARTIFACT REGISTRY ---
  REPO_NAME: property-transaction-coordinator-front
  SERVICE_NAME: trans-coor-front-server

  # --- 3. RUNTIME IDENTITY (Cloud Run) ---
  RUNTIME_SERVICE_ACCOUNT: prop-coord-fe-runtime-sa@property-transaction.iam.gserviceaccount.com

  # --- 4. VPC_CONNECTOR_NAME ---
  VPC_CONNECTOR_NAME: conn-app-backend

jobs:
  # ========================================================================
  # JOB 1: CI (Continuous Integration)
  # ========================================================================
  quality-checks:
    name: Quality & Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint Check
        run: pnpm run eslint

      - name: Build Check
        run: pnpm run build
        env:
          # Dummy values for build time
          AUTH0_SECRET: dummy_secret_for_build_check
          AUTH0_CLIENT_ID: dummy_client_id
          AUTH0_CLIENT_SECRET: dummy_client_secret
          AUTH0_BASE_URL: http://localhost:3000
          AUTH0_ISSUER_BASE_URL: https://dummy.auth0.com
          AUTH0_SCOPE: openid profile email
          APP_BASE_URL: http://localhost:3000

  # ========================================================================
  # JOB 2: CD - Build & Push
  # ========================================================================
  build-container:
    name: Build & Push Image
    needs: quality-checks
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest

    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Authenticate Google Cloud
        id: auth
        uses: "google-github-actions/auth@v2"
        with:
          token_format: "access_token"
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Authenticate Docker
        uses: "docker/login-action@v3"
        with:
          registry: ${{ env.REGION }}-docker.pkg.dev
          username: "oauth2accesstoken"
          password: ${{ steps.auth.outputs.access_token }}

      - name: Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}

  # ========================================================================
  # JOB 3: CD - Deploy Service
  # ========================================================================
  deploy-cloudrun:
    name: Deploy Service
    needs: build-container
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest

    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Authenticate Google Cloud
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      # REEMPLAZO: Ejecuta el comando gcloud run deploy directamente (m√°s robusto)
      - name: Deploy to Cloud Run (Native gcloud Command)
        run: |
          ENV_VARS="NODE_ENV=production"
          SECRETS="AUTH0_SECRET=AUTH0_SECRET:latest,AUTH0_CLIENT_SECRET=AUTH0_CLIENT_SECRET:latest,APP_BASE_URL=APP_BASE_URL:latest,AUTH0_AUDIENCE=AUTH0_AUDIENCE:latest,AUTH0_SCOPE=AUTH0_SCOPE:latest,AUTH0_CLIENT_ID=AUTH0_CLIENT_ID:latest,AUTH0_DOMAIN=AUTH0_DOMAIN:latest,BACKEND_API_URL=BACKEND_API_URL:latest,AUTH0_COOKIE_SAME_SITE=AUTH0_COOKIE_SAME_SITE:latest,AUTH0_COOKIE_SECURE=AUTH0_COOKIE_SECURE:latest,AUTH0_ISSUER_URL=AUTH0_ISSUER_URL:latest"

          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --service-account ${{ env.RUNTIME_SERVICE_ACCOUNT }} \
            --port 3000 \
            --update-env-vars ${ENV_VARS} \
            --update-secrets ${SECRETS} \
            --allow-unauthenticated \
            --ingress all \
            --vpc-connector ${{ env.VPC_CONNECTOR_NAME }} \
            --vpc-egress all-traffic \
            --format json

      - name: Ensure Public Invoker Role (Fix Warning)
        if: success() # Ejecutar si el deploy fue exitoso (a pesar de la advertencia)
        run: |
          echo "Explicitly binding 'roles/run.invoker' to 'allUsers' to ensure public access..."
          gcloud run services add-iam-policy-binding ${{ env.SERVICE_NAME }} \
            --member="allUsers" \
            --role="roles/run.invoker" \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}"
