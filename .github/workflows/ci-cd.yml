name: Frontend CI/CD Pipeline (Next.js to Firebase App Hosting - Secure)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  # --- 1. FIREBASE/GCP Environment Configuration ---
  # App Hosting Backend ID (required for the deploy command)
  FIREBASE_BACKEND_ID: trans-coor-front-server
  # Your Google Cloud Project ID
  PROJECT_ID: property-transaction
  # Deployment region for the Next.js server
  REGION: us-east4

jobs:
  deploy-frontend:
    name: Deploy to Firebase App Hosting
    runs-on: ubuntu-latest

    # GitHub Actions permissions required to use WIF
    permissions:
      contents: "read"
      id-token: "write" # Required for WIF authentication

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- 1. Authenticate with Google Cloud (Workload Identity Federation) ---
      # Uses the GCP_WIF_PROVIDER and GCP_SERVICE_ACCOUNT_EMAIL secrets from GitHub
      - name: Authenticate Google Cloud
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      # --- 2. Setup Node.js and Dependencies ---
      # Install pnpm first (Recommended for pnpm projects)
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          # cache-dependency-path: pnpm-lock.yaml # Optional, usually auto-detected

      - name: Install Dependencies
        # Use frozen-lockfile for consistent CI builds
        run: pnpm install --frozen-lockfile

      # --- 3. Install Firebase CLI ---
      - name: Install Firebase CLI
        # Using pnpm to install global packages
        run: pnpm install -g firebase-tools

      # --- 4. Deploy to Firebase App Hosting ---
      - name: Deploy to Firebase App Hosting
        run: |
          echo "Starting secure deployment for backend: ${{ env.FIREBASE_BACKEND_ID }}"

          # The firebase deploy command reads apphosting.yaml.
          # GCP secrets and custom SA are automatically managed by Firebase/Cloud Run.
          firebase deploy --only apphosting --project ${{ env.PROJECT_ID }}
